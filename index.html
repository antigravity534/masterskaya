<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è –≠–ª–µ–∫—Ç—Ä–æ—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root {
            --tg-theme-bg-color: #fff;
            --tg-theme-text-color: #000;
            --tg-theme-button-color: #248bed;
            --tg-theme-button-text-color: #fff;
            --tg-theme-secondary-bg-color: #efeff4;
            --tg-theme-hint-color: #999;
        }

        [v-cloak] { display: none; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            margin: 0; padding: 15px;
            padding-top: 10px;
        }

        /* –ü–æ–∏—Å–∫ */
        .search-container {
            position: sticky;
            top: 0;
            background: var(--tg-theme-bg-color);
            padding: 5px 0 10px 0;
            z-index: 10;
        }
        .search-input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.1);
            background: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
            font-size: 16px;
            box-sizing: border-box;
            outline: none;
        }

        /* –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ */
        .sort-container {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .sort-select {
            background: none;
            border: none;
            color: var(--tg-theme-button-color);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            outline: none;
        }

        .card {
            background-color: var(--tg-theme-secondary-bg-color);
            padding: 16px; border-radius: 12px; margin-bottom: 12px;
            cursor: pointer; border: 1px solid rgba(0,0,0,0.05);
        }

        .price { color: var(--tg-theme-button-color); font-weight: bold; }
        .desc { font-size: 0.9em; color: var(--tg-theme-hint-color); margin: 4px 0; }
        .cat-tag { 
            font-size: 0.75em; 
            text-transform: uppercase; 
            background: rgba(0,0,0,0.05); 
            padding: 2px 6px; 
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 5px;
        }

        .btn {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none; width: 100%; padding: 14px; border-radius: 10px;
            font-weight: bold; font-size: 16px; cursor: pointer;
        }

        input[type="text"], input[type="tel"], select {
            width: 100%; padding: 12px; margin: 8px 0 16px;
            border: 1px solid #ccc; border-radius: 8px;
            background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color);
            font-size: 16px; box-sizing: border-box;
        }

        .back-link { color: var(--tg-theme-button-color); cursor: pointer; margin-bottom: 15px; display: block; font-weight: 500; }
        .loading-screen { text-align: center; margin-top: 100px; color: var(--tg-theme-hint-color); }
    </style>
</head>
<body>

<div id="app" v-cloak>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div v-if="loading" class="loading-screen">
        –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
    </div>

    <div v-else>
        <!-- 1. –ü–û–ò–°–ö (–≤—Å–µ–≥–¥–∞ —Å–≤–µ—Ä—Ö—É) -->
        <div class="search-container" v-if="view !== 'details'">
            <input 
                type="text" 
                class="search-input" 
                v-model="searchQuery" 
                placeholder="üîç –ü–æ–∏—Å–∫ —É—Å–ª—É–≥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ø—Ä–æ–∫–æ–ª)"
            >
        </div>

        <!-- 2. –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù (–ö–ê–¢–ï–ì–û–†–ò–ò) -->
        <div v-if="view === 'categories' && !isSearching">
            <h2>–ö–∞—Ç–∞–ª–æ–≥ —É—Å–ª—É–≥</h2>
            <div v-for="cat in uniqueCategories" :key="cat" class="card" @click="openCategory(cat)">
                <strong>{{ cat }}</strong>
            </div>
        </div>

        <!-- 3. –°–ü–ò–°–û–ö –£–°–õ–£–ì (–í –ö–ê–¢–ï–ì–û–†–ò–ò –ò–õ–ò –ü–û–ò–°–ö) -->
        <div v-if="view === 'services' || isSearching">
            <div v-if="!isSearching" class="back-link" @click="goBack">‚Üê –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
            <div v-else class="back-link" @click="searchQuery = ''">‚úï –°–±—Ä–æ—Å–∏—Ç—å –ø–æ–∏—Å–∫</div>

            <div class="sort-container">
                <h2 style="margin:0">{{ isSearching ? '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞' : currentCategory }}</h2>
                <select v-model="sortBy" class="sort-select">
                    <option value="default">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
                    <option value="price_asc">–î–µ—à–µ–≤–ª–µ</option>
                    <option value="price_desc">–î–æ—Ä–æ–∂–µ</option>
                    <option value="name">–ê-–Ø</option>
                </select>
            </div>

            <div v-if="displayedServices.length === 0" class="loading-screen">
                –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ...
            </div>

            <div v-for="s in displayedServices" :key="s.name" class="card" @click="openDetails(s)">
                <div v-if="isSearching" class="cat-tag">{{ s.category }}</div>
                <strong>{{ s.name }}</strong>
                <div class="desc">{{ s.desc }}</div>
                <div class="price">{{ s.price }} —Ä—É–±.</div>
            </div>
        </div>

        <!-- 4. –û–§–û–†–ú–õ–ï–ù–ò–ï –ó–ê–ü–ò–°–ò -->
        <div v-if="view === 'details'">
            <div class="back-link" @click="view = 'services'">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</div>
            <h2>{{ selectedService.name }}</h2>
            <p class="desc">{{ selectedService.desc }}</p>
            <p>–¶–µ–Ω–∞: <span class="price">{{ selectedService.price }} —Ä—É–±.</span></p>
            <hr>
            <label>–í–∞—à–µ –∏–º—è</label>
            <input v-model="form.name" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
            <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input v-model="form.phone" type="tel" placeholder="+7...">
            <label>–í—Ä–µ–º—è –∑–∞–ø–∏—Å–∏</label>
            <select v-model="form.time">
                <option v-for="slot in timeSlots" :key="slot" :value="slot" :disabled="isSlotFull(slot)">
                    {{ slot }} {{ isSlotFull(slot) ? '(–∑–∞–Ω—è—Ç–æ)' : '' }}
                </option>
            </select>
            <button class="btn" @click="submitBooking" :disabled="submitting || isSlotFull(form.time)">
                {{ submitting ? '–û—Ç–ø—Ä–∞–≤–∫–∞...' : '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å' }}
            </button>
        </div>
    </div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbw9AstBi2VXyep9ORefWpgq_c1UNKi1ythL0hkdX5HPna83vcmpGdozpNK7_MuHrJm3/exec'; 

    const { createApp } = Vue;

    createApp({
        data() {
            return {
                view: 'categories',
                loading: true,
                submitting: false,
                services: [],
                bookedCounts: {},
                maxBookings: 1,
                currentCategory: '',
                selectedService: null,
                searchQuery: '',
                sortBy: 'default',
                form: { name: '', phone: '', time: '10:00' },
                timeSlots: []
            }
        },
        computed: {
            isSearching() {
                return this.searchQuery.trim().length > 0;
            },
            uniqueCategories() {
                return [...new Set(this.services.map(s => s.category))];
            },
            // –ì–õ–ê–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –§–ò–õ–¨–¢–†–ê–¶–ò–ò –ò –°–û–†–¢–ò–†–û–í–ö–ò
            displayedServices() {
                let result = [];

                // 1. –°–Ω–∞—á–∞–ª–∞ —Ñ–∏–ª—å—Ç—Ä—É–µ–º (–ø–æ –ø–æ–∏—Å–∫—É –∏–ª–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
                if (this.isSearching) {
                    const q = this.searchQuery.toLowerCase();
                    result = this.services.filter(s => 
                        s.name.toLowerCase().includes(q) || 
                        s.desc.toLowerCase().includes(q) ||
                        s.category.toLowerCase().includes(q)
                    );
                } else {
                    result = this.services.filter(s => s.category === this.currentCategory);
                }

                // 2. –ó–∞—Ç–µ–º —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
                const list = [...result];
                if (this.sortBy === 'price_asc') {
                    list.sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
                } else if (this.sortBy === 'price_desc') {
                    list.sort((a, b) => parseFloat(b.price) - parseFloat(a.price));
                } else if (this.sortBy === 'name') {
                    list.sort((a, b) => a.name.localeCompare(b.name));
                }
                
                return list;
            }
        },
        methods: {
            async fetchData() {
                try {
                    const response = await fetch(API_URL);
                    const data = await response.json();
                    this.services = data.services || [];
                    this.bookedCounts = data.bookedCounts || {};
                    this.maxBookings = data.maxBookings;
                    this.loading = false;
                } catch (e) {
                    alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö!");
                }
            },
            isSlotFull(slot) {
                if (this.maxBookings === 0) return true;
                return (this.bookedCounts[slot] || 0) >= this.maxBookings;
            },
            openCategory(cat) { 
                this.currentCategory = cat; 
                this.view = 'services'; 
                this.searchQuery = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∏—Å–∫ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                window.scrollTo(0,0);
            },
            openDetails(s) { 
                this.selectedService = s; 
                this.view = 'details'; 
                window.scrollTo(0,0);
            },
            goBack() {
                this.view = 'categories';
                this.sortBy = 'default';
            },
            generateSlots() {
                for (let h = 10; h <= 20; h++) {
                    this.timeSlots.push(`${h}:00`, `${h}:30`);
                }
            },
            async submitBooking() {
                if (!this.form.name || !this.form.phone) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!");
                this.submitting = true;
                try {
                    await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({...this.form, service: this.selectedService.name})
                    });
                    alert("–ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞! –ú—ã –ø–æ–ª—É—á–∏–ª–∏ –≤–∞—à–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.");
                    if (window.Telegram.WebApp) window.Telegram.WebApp.close();
                } catch (e) { alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ"); }
                finally { this.submitting = false; }
            }
        },
        mounted() {
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }
            this.generateSlots();
            this.fetchData();
        }
    }).mount('#app');
</script>

</body>
</html>

