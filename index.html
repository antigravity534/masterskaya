<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мастерская: Запись</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        :root { --tg-theme-bg-color: #fff; --tg-theme-text-color: #000; --tg-theme-button-color: #248bed; }
        body { font-family: sans-serif; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); padding: 15px; }
        .category-card, .service-card { background: rgba(0,0,0,0.05); padding: 15px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; }
        .btn { background: var(--tg-theme-button-color); color: #fff; border: none; width: 100%; padding: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .btn:disabled { opacity: 0.5; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        option:disabled { color: #ccc; }
        .back { color: var(--tg-theme-button-color); cursor: pointer; margin-bottom: 15px; display: block; }
    </style>
</head>
<body>
    <div id="app">
        <div v-if="loading" style="text-align:center; padding: 50px;">Загрузка...</div>

        <!-- Экран категорий -->
        <div v-if="!loading && view === 'categories'">
            <h2>Каталог услуг</h2>
            <div v-for="cat in uniqueCategories" class="category-card" @click="currentCategory = cat; view = 'services'">
                {{ cat }}
            </div>
        </div>

        <!-- Экран услуг -->
        <div v-if="view === 'services'">
            <span class="back" @click="view = 'categories'">← Назад</span>
            <h2>{{ currentCategory }}</h2>
            <div v-for="s in filteredServices" class="service-card" @click="selectedService = s; view = 'details'">
                <strong>{{ s.name }}</strong><br> {{ s.price }} руб.
            </div>
        </div>

        <!-- Экран оформления -->
        <div v-if="view === 'details'">
            <span class="back" @click="view = 'services'">← Назад</span>
            <h2>{{ selectedService.name }}</h2>
            <p>{{ selectedService.desc }}</p>
            
            <label>Ваше имя:</label>
            <input v-model="form.name" placeholder="Введите имя">
            
            <label>Телефон:</label>
            <input v-model="form.phone" type="tel" placeholder="+7...">

            <label>Время (на сегодня):</label>
            <select v-model="form.time">
                <option v-for="slot in timeSlots" 
                        :key="slot" 
                        :value="slot" 
                        :disabled="isFull(slot)">
                    {{ slot }} {{ isFull(slot) ? '(занято)' : '' }}
                </option>
            </select>

            <button class="btn" @click="send" :disabled="submitting || isFull(form.time)">
                {{ submitting ? 'Отправка...' : 'Подтвердить запись' }}
            </button>
        </div>
    </div>

    <script>
        const API_URL = 'ТВОЙ_URL_ИЗ_GOOGLE';

        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    view: 'categories',
                    loading: true,
                    submitting: false,
                    services: [],
                    bookedCounts: {}, // Тут будут данные о занятых местах
                    maxBookings: 1,
                    currentCategory: '',
                    selectedService: null,
                    form: { name: '', phone: '', time: '10:00' },
                    timeSlots: []
                }
            },
            computed: {
                uniqueCategories() { return [...new Set(this.services.map(s => s.category))]; },
                filteredServices() { return this.services.filter(s => s.category === this.currentCategory); }
            },
            methods: {
                async load() {
                    try {
                        const r = await fetch(API_URL);
                        const d = await r.json();
                        this.services = d.services;
                        this.bookedCounts = d.bookedCounts || {};
                        this.maxBookings = d.maxBookings || 1;
                        this.loading = false;
                    } catch (e) { alert("Ошибка загрузки"); }
                },
                generateSlots() {
                    for (let h = 10; h <= 20; h++) {
                        this.timeSlots.push(`${h}:00`, `${h}:30`);
                    }
                },
                isFull(slot) {
                    // Проверяем, сколько раз это время уже встречается в Bookings
                    const count = this.bookedCounts[slot] || 0;
                    return count >= this.maxBookings;
                },
                async send() {
                    if (!this.form.name || !this.form.phone) return alert("Заполните поля");
                    this.submitting = true;
                    try {
                        await fetch(API_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: JSON.stringify({...this.form, service: this.selectedService.name})
                        });
                        alert("Вы успешно записаны!");
                        window.Telegram.WebApp.close();
                    } catch (e) { alert("Ошибка при отправке"); }
                }
            },
            mounted() {
                this.generateSlots();
                this.load();
                window.Telegram.WebApp.ready();
            }
        }).mount('#app');
    </script>
</body>
</html>
