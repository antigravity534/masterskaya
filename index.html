<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è –≠–ª–µ–∫—Ç—Ä–æ—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root {
            --tg-theme-bg-color: #fff;
            --tg-theme-text-color: #000;
            --tg-theme-button-color: #248bed;
            --tg-theme-button-text-color: #fff;
            --tg-theme-secondary-bg-color: #efeff4;
            --tg-theme-hint-color: #999;
        }

        [v-cloak] { display: none; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            margin: 0; padding: 15px;
        }

        /* –ü–æ–∏—Å–∫ */
        .search-input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.1);
            background: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
            font-size: 16px;
            box-sizing: border-box;
            outline: none;
            margin-bottom: 20px;
        }

        .sort-container {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .sort-select {
            background: none;
            border: none;
            color: var(--tg-theme-button-color);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .card {
            background-color: var(--tg-theme-secondary-bg-color);
            padding: 16px; border-radius: 12px; margin-bottom: 12px;
            cursor: pointer; border: 1px solid rgba(0,0,0,0.05);
        }

        .price { color: var(--tg-theme-button-color); font-weight: bold; }
        .desc { font-size: 0.9em; color: var(--tg-theme-hint-color); margin: 4px 0; }
        
        /* –ö–∞—Ç–µ–≥–æ—Ä–∏—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –ø–æ–∏—Å–∫–∞ —Ç–µ–ø–µ—Ä—å —Å–Ω–∏–∑—É */
        .cat-tag { 
            font-size: 0.75em; 
            color: var(--tg-theme-hint-color);
            display: block;
            margin-top: 4px;
        }

        .btn {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none; width: 100%; padding: 14px; border-radius: 10px;
            font-weight: bold; font-size: 16px; cursor: pointer;
        }

        input[type="text"], input[type="tel"], select {
            width: 100%; padding: 12px; margin: 8px 0 16px;
            border: 1px solid #ccc; border-radius: 8px;
            background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color);
            font-size: 16px; box-sizing: border-box;
        }

        .back-link { color: var(--tg-theme-button-color); cursor: pointer; margin-bottom: 15px; display: block; font-weight: 500; }
        .loading-screen { text-align: center; margin-top: 100px; color: var(--tg-theme-hint-color); }
    </style>
</head>
<body>

<div id="app" v-cloak>
    
    <div v-if="loading" class="loading-screen">
        –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
    </div>

    <div v-else>
        <!-- –ó–ê–ì–û–õ–û–í–û–ö -->
        <h2 style="margin-bottom: 10px;">{{ headerTitle }}</h2>

        <!-- –ü–û–ò–°–ö (–ü–û–î –ó–ê–ì–û–õ–û–í–ö–û–ú) -->
        <div v-if="view !== 'details'">
            <input 
                type="text" 
                class="search-input" 
                v-model="searchQuery" 
                placeholder="üîç –ù–∞–π—Ç–∏ —É—Å–ª—É–≥—É..."
            >
        </div>

        <!-- –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù (–ö–ê–¢–ï–ì–û–†–ò–ò) -->
        <div v-if="view === 'categories' && !isSearching">
            <div v-for="cat in uniqueCategories" :key="cat" class="card" @click="openCategory(cat)">
                <strong>{{ cat }}</strong>
            </div>
        </div>

        <!-- –°–ü–ò–°–û–ö –£–°–õ–£–ì (–í –ö–ê–¢–ï–ì–û–†–ò–ò –ò–õ–ò –ü–û–ò–°–ö) -->
        <div v-if="view === 'services' || isSearching">
            <div v-if="!isSearching" class="back-link" @click="goBack">‚Üê –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
            <div v-else class="back-link" @click="searchQuery = ''">‚úï –°–±—Ä–æ—Å–∏—Ç—å –ø–æ–∏—Å–∫</div>

            <div class="sort-container">
                <span style="font-size: 14px; color: var(--tg-theme-hint-color)">
                    –ù–∞–π–¥–µ–Ω–æ: {{ sortedServices.length }}
                </span>
                <select v-model="sortBy" class="sort-select">
                    <option value="default">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
                    <option value="price_asc">–î–µ—à–µ–≤–ª–µ</option>
                    <option value="price_desc">–î–æ—Ä–æ–∂–µ</option>
                    <option value="name">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–ê-–Ø)</option>
                </select>
            </div>

            <div v-for="s in sortedServices" :key="s.name" class="card" @click="openDetails(s)">
                <strong>{{ s.name }}</strong>
                <div class="desc">{{ s.desc }}</div>
                <div class="price">{{ s.price }} —Ä—É–±.</div>
                <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É—Å–ª—É–≥–∏ -->
                <span v-if="isSearching" class="cat-tag">–†–∞–∑–¥–µ–ª: {{ s.category }}</span>
            </div>
        </div>

        <!-- –û–§–û–†–ú–õ–ï–ù–ò–ï –ó–ê–ü–ò–°–ò -->
        <div v-if="view === 'details'">
            <div class="back-link" @click="view = 'services'">‚Üê –ö —Å–ø–∏—Å–∫—É —É—Å–ª—É–≥</div>
            <h2>{{ selectedService.name }}</h2>
            <p class="desc">{{ selectedService.desc }}</p>
            
            <label>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –∑–∞–ø–∏—Å–∏:</label>
            <select v-model="form.date">
                <option v-for="day in availableDates" :key="day.value" :value="day.value">
                    {{ day.label }}
                </option>
            </select>

            <label>–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è:</label>
            <select v-model="form.time">
                <option v-for="slot in filteredTimeSlots" :key="slot" :value="slot" :disabled="isSlotFull(slot)">
                    {{ slot }} {{ isSlotFull(slot) ? '(–∑–∞–Ω—è—Ç–æ)' : '' }}
                </option>
            </select>

            <input v-model="form.name" placeholder="–í–∞—à–µ –∏–º—è">
            <input v-model="form.phone" type="tel" placeholder="+7...">
            
            <button class="btn" @click="submitBooking" :disabled="submitting || !form.time">
                {{ submitting ? '–û—Ç–ø—Ä–∞–≤–∫–∞...' : '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å' }}
            </button>
        </div>
    </div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbw9AstBi2VXyep9ORefWpgq_c1UNKi1ythL0hkdX5HPna83vcmpGdozpNK7_MuHrJm3/exec'; 

    const { createApp } = Vue;

    createApp({
        data() {
            return {
                view: 'categories',
                loading: true,
                submitting: false,
                services: [],
                bookedCounts: {},
                maxBookings: 1,
                currentCategory: '',
                selectedService: null,
                searchQuery: '',
                sortBy: 'default',
                serverToday: '',
                form: { name: '', phone: '', time: '', date: '' },
                availableDates: []
            }
        },
        computed: {
            headerTitle() {
                if (this.isSearching) return "–ü–æ–∏—Å–∫";
                if (this.view === 'categories') return "–ö–∞—Ç–∞–ª–æ–≥ —É—Å–ª—É–≥";
                if (this.view === 'services') return this.currentCategory;
                return "–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ";
            },
            isSearching() {
                return this.searchQuery.trim().length > 0;
            },
            uniqueCategories() {
                return [...new Set(this.services.map(s => s.category))];
            },
            // –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ò –°–û–†–¢–ò–†–û–í–ö–ê
            sortedServices() {
                let list = [];
                if (this.isSearching) {
                    const q = this.searchQuery.toLowerCase();
                    list = this.services.filter(s => s.name.toLowerCase().includes(q));
                } else {
                    list = this.services.filter(s => s.category === this.currentCategory);
                }

                const result = [...list];
                if (this.sortBy === 'price_asc') result.sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
                else if (this.sortBy === 'price_desc') result.sort((a, b) => parseFloat(b.price) - parseFloat(a.price));
                else if (this.sortBy === 'name') result.sort((a, b) => a.name.localeCompare(b.name));
                
                return result;
            },
            // –£–ú–ù–û–ï –í–†–ï–ú–Ø: —Å–∫—Ä—ã–≤–∞–µ–º —Ç–æ, —á—Ç–æ —É–∂–µ –ø—Ä–æ—à–ª–æ
            filteredTimeSlots() {
                const slots = [];
                for (let h = 10; h <= 20; h++) {
                    slots.push(`${h}:00`, `${h}:30`);
                }

                if (this.form.date === this.serverToday) {
                    const now = new Date();
                    const currentTotalMinutes = now.getHours() * 60 + now.getMinutes();
                    
                    return slots.filter(slot => {
                        const [h, m] = slot.split(':').map(Number);
                        const slotTotalMinutes = h * 60 + m;
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–ª–æ—Ç–∞ –µ—â–µ —Ö–æ—Ç—è –±—ã 30 –º–∏–Ω—É—Ç
                        return slotTotalMinutes > (currentTotalMinutes + 30);
                    });
                }
                return slots;
            }
        },
        methods: {
            async fetchData() {
                try {
                    const response = await fetch(API_URL);
                    const data = await response.json();
                    this.services = data.services || [];
                    this.bookedCounts = data.bookedCounts || {};
                    this.maxBookings = data.maxBookings;
                    this.serverToday = data.serverToday;
                    this.form.date = data.serverToday; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è
                    
                    this.generateAvailableDates();
                    this.loading = false;
                } catch (e) {
                    alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö!");
                }
            },
            generateAvailableDates() {
                const dates = [];
                const daysOfWeek = ["–≤—Å", "–ø–Ω", "–≤—Ç", "—Å—Ä", "—á—Ç", "–ø—Ç", "—Å–±"];
                
                // –ë–µ—Ä–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É —Å —Å–µ—Ä–≤–µ—Ä–∞
                const [d, m, y] = this.serverToday.split('.').map(Number);
                const baseDate = new Date(y, m - 1, d);

                for (let i = 0; i < 7; i++) {
                    const targetDate = new Date(baseDate);
                    targetDate.setDate(baseDate.getDate() + i);
                    
                    const dd = String(targetDate.getDate()).padStart(2, '0');
                    const mm = String(targetDate.getMonth() + 1).padStart(2, '0');
                    const yyyy = targetDate.getFullYear();
                    const dateStr = `${dd}.${mm}.${yyyy}`;
                    
                    let label = "";
                    if (i === 0) label = "–°–µ–≥–æ–¥–Ω—è";
                    else if (i === 1) label = "–ó–∞–≤—Ç—Ä–∞";
                    else label = `${dd}.${mm} (${daysOfWeek[targetDate.getDay()]})`;
                    
                    dates.push({ label, value: dateStr });
                }
                this.availableDates = dates;
            },
            isSlotFull(slot) {
                if (this.maxBookings === 0) return true;
                const dayCounts = this.bookedCounts[this.form.date] || {};
                return (dayCounts[slot] || 0) >= this.maxBookings;
            },
            openCategory(cat) { 
                this.currentCategory = cat; 
                this.view = 'services'; 
                this.searchQuery = '';
                window.scrollTo(0,0);
            },
            openDetails(s) { 
                this.selectedService = s; 
                this.view = 'details'; 
                window.scrollTo(0,0);
            },
            goBack() {
                this.view = 'categories';
                this.sortBy = 'default';
            },
            async submitBooking() {
                if (!this.form.name || !this.form.phone || !this.form.time) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ!");
                this.submitting = true;
                try {
                    await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({...this.form, service: this.selectedService.name})
                    });
                    alert("–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!");
                    if (window.Telegram.WebApp) window.Telegram.WebApp.close();
                } catch (e) { alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ"); }
                finally { this.submitting = false; }
            }
        },
        mounted() {
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }
            this.fetchData();
        }
    }).mount('#app');
</script>

</body>
</html>

