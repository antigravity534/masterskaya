<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è –≠–ª–µ–∫—Ç—Ä–æ—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        /* --- –ù–ê–°–¢–†–û–ô–ö–ò –¶–í–ï–¢–û–í --- */
        :root {
            --btn-bg-color: #248bed;       /* –¶–≤–µ—Ç –∑–∞–ª–∏–≤–∫–∏ –∫–Ω–æ–ø–æ–∫ */
            --btn-text-color: #ffffff;     /* –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö */
            --bg-color: #ffffff;           /* –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–Ω —Å–∞–π—Ç–∞ */
            --text-color: #000000;         /* –û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ */
            --secondary-bg: #efeff4;       /* –§–æ–Ω –∫–∞—Ä—Ç–æ—á–µ–∫ –∏ –∏–Ω–ø—É—Ç–æ–≤ */
            --hint-color: #999999;         /* –¶–≤–µ—Ç –ø–æ–¥—Å–∫–∞–∑–æ–∫ */
        }

        [v-cloak] { display: none; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 15px;
            padding-top: 10px;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ */
        h2 { margin-top: 5px; margin-bottom: 10px; }

        /* –ü–æ–∏—Å–∫ (–ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º) */
        .search-input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.1);
            background: var(--secondary-bg);
            color: var(--text-color);
            font-size: 16px;
            box-sizing: border-box;
            outline: none;
            margin-bottom: 20px;
            display: block;
        }

        .sort-container {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .sort-select-ui {
            background: none;
            border: none;
            color: var(--btn-bg-color);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            width: auto; margin: 0; padding: 5px;
        }

        .card {
            background-color: var(--secondary-bg);
            padding: 16px; border-radius: 12px; margin-bottom: 12px;
            cursor: pointer; border: 1px solid rgba(0,0,0,0.05);
        }

        .price { color: var(--btn-bg-color); font-weight: bold; }
        .desc { font-size: 0.9em; color: var(--hint-color); margin: 4px 0; }
        
        /* –ö–∞—Ç–µ–≥–æ—Ä–∏—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –ø–æ–∏—Å–∫–∞ */
        .cat-tag { 
            font-size: 0.75em; 
            color: var(--hint-color);
            display: block;
            margin-top: 6px;
        }

        .btn {
            background-color: var(--btn-bg-color);
            color: var(--btn-text-color);
            border: none; width: 100%; padding: 14px; border-radius: 10px;
            font-weight: bold; font-size: 16px; cursor: pointer;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π (–ò–º—è, –¢–µ–ª–µ—Ñ–æ–Ω, –°–µ–ª–µ–∫—Ç—ã) */
        input, select {
            width: 100%; 
            padding: 12px; 
            margin: 8px 0 16px;
            border: 1px solid #ccc; 
            border-radius: 8px;
            background: var(--bg-color); 
            color: var(--text-color);
            font-size: 16px; 
            box-sizing: border-box;
            display: block;
            outline: none;
        }

        .back-link { color: var(--btn-bg-color); cursor: pointer; margin-bottom: 15px; display: block; font-weight: 500; }
        .loading-screen { text-align: center; margin-top: 100px; color: var(--hint-color); }
    </style>
</head>
<body>

<div id="app" v-cloak>
    
    <div v-if="loading" class="loading-screen">
        –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞...
    </div>

    <div v-else>
        <!-- –ó–ê–ì–û–õ–û–í–û–ö -->
        <h2>{{ headerTitle }}</h2>

        <!-- –ü–û–ò–°–ö (–ü–û–î –ó–ê–ì–û–õ–û–í–ö–û–ú) -->
        <div v-if="view !== 'details'">
            <input 
                type="text" 
                class="search-input" 
                v-model="searchQuery" 
                placeholder="üîç –ù–∞–π—Ç–∏ —É—Å–ª—É–≥—É..."
            >
        </div>

        <!-- –ö–ê–¢–ï–ì–û–†–ò–ò -->
        <div v-if="view === 'categories' && !isSearching">
            <div v-for="cat in uniqueCategories" :key="cat" class="card" @click="openCategory(cat)">
                <strong>{{ cat }}</strong>
            </div>
        </div>

        <!-- –°–ü–ò–°–û–ö –£–°–õ–£–ì -->
        <div v-if="view === 'services' || isSearching">
            <div v-if="!isSearching" class="back-link" @click="goBack">‚Üê –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
            <div v-else class="back-link" @click="searchQuery = ''">‚úï –°–±—Ä–æ—Å–∏—Ç—å –ø–æ–∏—Å–∫</div>

            <div class="sort-container">
                <span style="font-size: 13px; color: var(--hint-color)">
                    –ù–∞–π–¥–µ–Ω–æ: {{ sortedServices.length }}
                </span>
                <select v-model="sortBy" class="sort-select-ui">
                    <option value="default">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
                    <option value="price_asc">–î–µ—à–µ–≤–ª–µ</option>
                    <option value="price_desc">–î–æ—Ä–æ–∂–µ</option>
                    <option value="name">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
                </select>
            </div>

            <div v-for="s in sortedServices" :key="s.name" class="card" @click="openDetails(s)">
                <strong>{{ s.name }}</strong>
                <div class="desc" v-if="s.desc">{{ s.desc }}</div>
                <div class="price">{{ s.price }} —Ä—É–±.</div>
                <!-- –í –ø–æ–∏—Å–∫–µ –ø–∏—à–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å–Ω–∏–∑—É -->
                <span v-if="isSearching" class="cat-tag">–†–∞–∑–¥–µ–ª: {{ s.category }}</span>
            </div>
        </div>

        <!-- –û–§–û–†–ú–õ–ï–ù–ò–ï –ó–ê–ü–ò–°–ò -->
        <div v-if="view === 'details'">
            <div class="back-link" @click="view = 'services'">‚Üê –ö —Å–ø–∏—Å–∫—É —É—Å–ª—É–≥</div>
            <h2>{{ selectedService.name }}</h2>
            <p class="desc" v-if="selectedService.desc">{{ selectedService.desc }}</p>
            
            <label>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –∑–∞–ø–∏—Å–∏:</label>
            <select v-model="form.date">
                <option v-for="day in availableDates" :key="day.value" :value="day.value">
                    {{ day.label }}
                </option>
            </select>

            <label>–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è:</label>
            <select v-model="form.time">
                <option v-if="filteredTimeSlots.length === 0" disabled value="">–ù–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</option>
                <option v-for="slot in filteredTimeSlots" :key="slot" :value="slot" :disabled="isSlotFull(slot)">
                    {{ slot }} {{ isSlotFull(slot) ? '‚Äî (–∑–∞–Ω—è—Ç–æ)' : '' }}
                </option>
            </select>

            <label>–í–∞—à–µ –∏–º—è:</label>
            <input v-model="form.name" type="text" placeholder="–ò–º—è">
            
            <label>–¢–µ–ª–µ—Ñ–æ–Ω:</label>
            <input 
                v-model="form.phoneDisplay" 
                @input="handlePhoneInput" 
                type="tel" 
                placeholder="+7 (999) 000 00-00"
            >
            
            <button class="btn" @click="submitBooking" :disabled="submitting || !form.time || form.phoneDisplay.length < 18">
                {{ submitting ? '–û—Ç–ø—Ä–∞–≤–∫–∞...' : '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å' }}
            </button>
        </div>
    </div>
</div>

<script>
    const API_URL = '–¢–í–û–Ø_–°–°–´–õ–ö–ê_–ò–ó_GOOGLE_SCRIPTS'; 

    const { createApp } = Vue;

    createApp({
        data() {
            return {
                view: 'categories',
                loading: true,
                submitting: false,
                services: [],
                bookedCounts: {},
                maxBookings: 1,
                currentCategory: '',
                selectedService: null,
                searchQuery: '',
                sortBy: 'default',
                serverToday: '',
                form: { 
                    name: '', 
                    phoneDisplay: '+7 ', 
                    time: '', 
                    date: '' 
                },
                availableDates: []
            }
        },
        computed: {
            headerTitle() {
                if (this.isSearching) return "–ü–æ–∏—Å–∫";
                if (this.view === 'categories') return "–ö–∞—Ç–∞–ª–æ–≥ —É—Å–ª—É–≥";
                if (this.view === 'services') return this.currentCategory;
                return "–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ";
            },
            isSearching() {
                return this.searchQuery.trim().length > 0;
            },
            uniqueCategories() {
                return [...new Set(this.services.map(s => s.category))];
            },
            sortedServices() {
                let list = [];
                if (this.isSearching) {
                    const q = this.searchQuery.toLowerCase();
                    // –ü–æ–∏—Å–∫ –¢–û–õ–¨–ö–û –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —É—Å–ª—É–≥–∏
                    list = this.services.filter(s => s.name.toLowerCase().includes(q));
                } else {
                    list = this.services.filter(s => s.category === this.currentCategory);
                }

                const result = [...list];
                if (this.sortBy === 'price_asc') result.sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
                else if (this.sortBy === 'price_desc') result.sort((a, b) => parseFloat(b.price) - parseFloat(a.price));
                else if (this.sortBy === 'name') result.sort((a, b) => a.name.localeCompare(b.name));
                
                return result;
            },
            filteredTimeSlots() {
                const slots = [];
                for (let h = 10; h <= 20; h++) {
                    slots.push(`${h}:00`, `${h}:30`);
                }

                if (this.form.date === this.serverToday) {
                    const now = new Date();
                    const currentTotalMinutes = now.getHours() * 60 + now.getMinutes();
                    return slots.filter(slot => {
                        const [h, m] = slot.split(':').map(Number);
                        const slotTotalMinutes = h * 60 + m;
                        return slotTotalMinutes > (currentTotalMinutes + 30); // –ó–∞–ø–∞—Å 30 –º–∏–Ω—É—Ç
                    });
                }
                return slots;
            }
        },
        methods: {
            handlePhoneInput(e) {
                let input = e.target.value.replace(/\D/g, ''); // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
                
                // –ï—Å–ª–∏ —Å—Ç–µ—Ä–ª–∏ –≤—Å—ë, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º +7
                if (input.length === 0) {
                    this.form.phoneDisplay = '+7 ';
                    return;
                }

                // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 7
                if (!input.startsWith('7')) input = '7' + input;
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 11 —Ü–∏—Ñ—Ä–∞–º–∏
                input = input.substring(0, 11);

                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º: +7 (999) 000 00-00
                let formatted = '+7';
                if (input.length > 1) formatted += ' (' + input.substring(1, 4);
                if (input.length > 4) formatted += ') ' + input.substring(4, 7);
                if (input.length > 7) formatted += ' ' + input.substring(7, 9);
                if (input.length > 9) formatted += '-' + input.substring(9, 11);
                
                this.form.phoneDisplay = formatted;
            },
            async fetchData() {
                try {
                    const response = await fetch(API_URL);
                    const data = await response.json();
                    this.services = data.services || [];
                    this.bookedCounts = data.bookedCounts || {};
                    this.maxBookings = data.maxBookings;
                    this.serverToday = data.serverToday;
                    this.form.date = data.serverToday; 
                    
                    this.generateAvailableDates();
                    this.loading = false;
                } catch (e) {
                    alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏!");
                }
            },
            generateAvailableDates() {
                const dates = [];
                const daysOfWeek = ["–≤—Å", "–ø–Ω", "–≤—Ç", "—Å—Ä", "—á—Ç", "–ø—Ç", "—Å–±"];
                const [d, m, y] = this.serverToday.split('.').map(Number);
                const baseDate = new Date(y, m - 1, d);

                for (let i = 0; i < 7; i++) {
                    const targetDate = new Date(baseDate);
                    targetDate.setDate(baseDate.getDate() + i);
                    const dd = String(targetDate.getDate()).padStart(2, '0');
                    const mm = String(targetDate.getMonth() + 1).padStart(2, '0');
                    const yyyy = targetDate.getFullYear();
                    const dateStr = `${dd}.${mm}.${yyyy}`;
                    
                    let label = "";
                    if (i === 0) label = "–°–µ–≥–æ–¥–Ω—è";
                    else if (i === 1) label = "–ó–∞–≤—Ç—Ä–∞";
                    else label = `${dd}.${mm} (${daysOfWeek[targetDate.getDay()]})`;
                    
                    dates.push({ label, value: dateStr });
                }
                this.availableDates = dates;
            },
            isSlotFull(slot) {
                if (this.maxBookings === 0) return true;
                const dayCounts = this.bookedCounts[this.form.date] || {};
                return (dayCounts[slot] || 0) >= this.maxBookings;
            },
            openCategory(cat) { 
                this.currentCategory = cat; 
                this.view = 'services'; 
                this.searchQuery = '';
                window.scrollTo(0,0);
            },
            openDetails(s) { 
                this.selectedService = s; 
                this.view = 'details'; 
                window.scrollTo(0,0);
            },
            goBack() {
                this.view = 'categories';
                this.sortBy = 'default';
            },
            async submitBooking() {
                if (!this.form.name || !this.form.phoneDisplay || !this.form.time) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!");
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å—Ç—ã–µ —Ü–∏—Ñ—Ä—ã –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã
                const rawPhone = this.form.phoneDisplay.replace(/\D/g, '');
                const bookingDate = this.form.date;
                const bookingTime = this.form.time;
                
                this.submitting = true;
                try {
                    await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({
                            date: bookingDate,
                            time: bookingTime,
                            service: this.selectedService.name,
                            name: this.form.name,
                            phone: rawPhone
                        })
                    });

                    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
                    if (!this.bookedCounts[bookingDate]) this.bookedCounts[bookingDate] = {};
                    this.bookedCounts[bookingDate][bookingTime] = (this.bookedCounts[bookingDate][bookingTime] || 0) + 1;

                    alert("–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!");
                    if (window.Telegram && window.Telegram.WebApp) {
                        setTimeout(() => { window.Telegram.WebApp.close(); }, 1000);
                    } else {
                        this.view = 'categories';
                        this.submitting = false;
                    }
                } catch (e) { 
                    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ"); 
                    this.submitting = false;
                }
            }
        },
        mounted() {
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }
            this.fetchData();
        }
    }).mount('#app');
</script>

</body>
</html>
